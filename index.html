<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Startpage</title>

    <!-- Theme + page CSS (keep your files as-is) -->
    <link rel="stylesheet" href="./main-themes/blue/style.css" />
    <link rel="stylesheet" href="./style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet" />
  </head>

  <body>
    <nav class="navbar" aria-label="Theme & profile selector">
      <div class="navbar-container container">
        <input type="checkbox" id="nav-toggle" />
        <div class="hamburger-lines" aria-hidden="true">
          <span class="line line1"></span>
          <span class="line line2"></span>
          <span class="line line3"></span>
        </div>

        <ul class="menu-items" id="theme-menu">
          <!-- Themes -->
          <li><a href="#" data-theme="blue">blue</a></li>
          <li><a href="#" data-theme="cherry">cherry</a></li>
          <li><a href="#" data-theme="violet">violet</a></li>
          <li><a href="#" data-theme="green">green</a></li>
          <li><a href="#" data-theme="mesh-purple">mesh-purple</a></li>
          <li><a href="#" data-theme="orange">orange</a></li>
          <li><a href="#" data-theme="purple">purple</a></li>
          <li><a href="#" data-theme="white">white</a></li>
          <li><a href="#" data-theme="retro-gradient">retro-gradient</a></li>
          <li><a href="#" data-theme="summer-wave">summer-wave</a></li>
          <li><a href="#" data-theme="Animated-Gradient">animated-gradient</a></li>

          <!-- Profiles header (items are injected by JS) -->
          <li class="menu-divider" aria-hidden="true"></li>
          <li class="menu-heading">Profiles</li>
          <!-- JS will append: <li><a href="#" data-profile="default">Default</a></li> -->
        </ul>
      </div>
    </nav>

    <!-- Clocks -->
    <div id="clocks" aria-live="polite"></div>

    <div class="wrapper">
      <div class="bg"></div>
      <div class="maincard" role="region" aria-label="Startpage">
        <div class="content">
          <div class="image"></div>

          <!-- Links injected from links-<profile>.json -->
          <div id="links" class="links"></div>
        </div>

        <!-- Search / Command Bar -->
        <div class="search" role="search">
          <form id="search-form" autocomplete="off">
            <label for="search_box">&gt; find / </label>
            <input
              type="text"
              placeholder="Type here or >command"
              name="search_box"
              id="search_box"
              autocomplete="off"
              inputmode="search"
              aria-label="Find or command"
            />
          </form>
          <small>Tip: <code>&gt;profile list</code>, <code>&gt;profile switch tour</code>, <code>&gt;note …</code></small>
        </div>
      </div>
    </div>

    <!-- Scratchpad (700px width via your CSS) -->
    <div class="scratchpad">
      <label for="scratch" class="visually-hidden">Scratchpad</label>
      <textarea id="scratch" rows="5" placeholder="Scratchpad (saved locally) — type notes here…"></textarea>
    </div>

    <script>
      /* ========= Helpers ========= */
      const $ = (q) => document.querySelector(q);

      /* ========= Theme Loader ========= */
      const themes = [
        "blue","cherry","violet","green","orange","purple",
        "white","mesh-purple","summer-wave","retro-gradient","Animated-Gradient"
      ];
      // Preload all themes disabled; your base theme CSS will also load
      themes.forEach((theme) => {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = `./main-themes/${theme}/style.css`;
        link.classList.add(`theme-${theme}`);
        link.disabled = true;
        document.head.appendChild(link);
      });
      function changeCSS(theme) {
        themes.forEach((t) => {
          const el = document.querySelector(`.theme-${t}`);
          if (el) el.disabled = t !== theme;
        });
        localStorage.setItem("selected-theme", theme);
      }
      const savedTheme = localStorage.getItem("selected-theme");
      if (savedTheme) changeCSS(savedTheme);

      // Theme menu delegation
      document.getElementById("theme-menu")?.addEventListener("click", (e) => {
        const a = e.target.closest("a");
        if (!a) return;
        const theme = a.getAttribute("data-theme");
        if (theme) {
          e.preventDefault();
          changeCSS(theme);
          $("#search_box")?.focus();
        }
        const prof = a.getAttribute("data-profile");
        if (prof) {
          e.preventDefault();
          setProfile(prof); // reload with ?profile=
        }
      });

      /* ========= Profiles (dynamic from profiles.json) ========= */
      let PROFILES = [];                 // [{id,label,theme?,timezones?,default?}, ...]
      const PROFILE_KEY = "profile";
      let ACTIVE_PROFILE = null;

      async function loadProfiles() {
        try {
          const res = await fetch("./profiles.json", { cache: "no-cache" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          PROFILES = Array.isArray(data.profiles) ? data.profiles : [];
        } catch (e) {
          PROFILES = [{ id: "default", label: "Default", default: true }];
        }
      }

      function pickInitialProfile() {
        const byId = (id) => PROFILES.find(p => p.id === id);
        const params = new URLSearchParams(location.search);
        const qp = params.get("profile");
        const stored = localStorage.getItem(PROFILE_KEY);

        if (qp && byId(qp)) {
          ACTIVE_PROFILE = qp;
        } else if (stored && byId(stored)) {
          ACTIVE_PROFILE = stored;
        } else {
          ACTIVE_PROFILE = (PROFILES.find(p => p.default) || PROFILES[0]).id;
        }
        localStorage.setItem(PROFILE_KEY, ACTIVE_PROFILE);
      }

      function setProfile(profileId) {
        localStorage.setItem(PROFILE_KEY, profileId);
        const params = new URLSearchParams(location.search);
        params.set("profile", profileId);
        location.search = params.toString(); // reload with ?profile=
      }

      function renderProfileMenu() {
        const menu = document.getElementById("theme-menu");
        if (!menu) return;
        // Remove existing profile entries
        [...menu.querySelectorAll('a[data-profile]')].forEach(a => a.parentElement.remove());

        const anchor = menu.querySelector(".menu-heading") || menu.lastElementChild;
        PROFILES.forEach(p => {
          const li = document.createElement("li");
          const a  = document.createElement("a");
          a.href = "#";
          a.setAttribute("data-profile", p.id);
          a.textContent = p.label + (p.id === ACTIVE_PROFILE ? " (current)" : "");
          if (p.id === ACTIVE_PROFILE) a.classList.add("profile-current");
          li.appendChild(a);
          anchor.parentNode.insertBefore(li, anchor.nextSibling);
        });
      }

      /* ========= Clocks ========= */
      const clocks  = $("#clocks");
      const timezones = ["Europe/London", "Europe/Berlin"]; // will be overridden by profile/theme if set

      function renderClocks() {
        if (!clocks) return;
        clocks.innerHTML = "";
        timezones.forEach(tz => {
          const div = document.createElement("div");
          div.className = "clock";
          div.dataset.tz = tz;
          clocks.appendChild(div);
        });
        updateClocks();
      }

      let clockTimer;
      function updateClocks() {
        const now = new Date();
        clocks.querySelectorAll(".clock").forEach(el => {
          const tz = el.dataset.tz;
          try {
            const fmt = new Intl.DateTimeFormat("en-GB", {
              timeZone: tz, hour: "2-digit", minute: "2-digit", second: "2-digit"
            });
            el.textContent = `${tz}: ${fmt.format(now)}`;
          } catch {
            el.textContent = `${tz}: [invalid tz]`;
          }
        });
      }

      /* ========= Scratchpad ========= */
      const scratch = $("#scratch");
      if (scratch) {
        scratch.value = localStorage.getItem("scratchpad") || "";
        scratch.addEventListener("input", () => {
          localStorage.setItem("scratchpad", scratch.value);
        });
      }

      /* ========= Links loader (by profile) ========= */
      async function loadLinksByProfile() {
        // Apply any profile-level theme/timezones defaults from profiles.json
        const active = PROFILES.find(p => p.id === ACTIVE_PROFILE);
        if (active?.theme && typeof changeCSS === "function") changeCSS(active.theme);
        if (Array.isArray(active?.timezones) && active.timezones.length) {
          timezones.splice(0, timezones.length, ...active.timezones);
          renderClocks();
          if (clockTimer) clearInterval(clockTimer);
          clockTimer = setInterval(updateClocks, 1000);
        }

        // Load file links-<profile>.json (fallback to links-default.json)
        const file = `./links-${ACTIVE_PROFILE}.json`;
        try {
          const res = await fetch(file, { cache: "no-cache" });
          if (!res.ok) throw new Error();
          const data = await res.json();
          applyFileMeta(data);
          renderLinks(data);
        } catch {
          const res = await fetch("./links-default.json", { cache: "no-cache" });
          const data = await res.json();
          applyFileMeta(data);
          renderLinks(data);
        }
      }

      function applyFileMeta(data) {
        if (data.title) document.title = data.title;
        if (data.theme && typeof changeCSS === "function") changeCSS(data.theme);
        if (Array.isArray(data.timezones) && data.timezones.length) {
          timezones.splice(0, timezones.length, ...data.timezones);
          renderClocks();
          if (clockTimer) clearInterval(clockTimer);
          clockTimer = setInterval(updateClocks, 1000);
        }
      }

      function renderLinks(data) {
        const container = $("#links");
        if (!container) return;
        const sections = Array.isArray(data.sections) ? data.sections : [];
        const frag = document.createDocumentFragment();

        for (const s of sections) {
          const sec = document.createElement("section");
          const h3 = document.createElement("h3");
          h3.textContent = s.title || "Links";
          const ul = document.createElement("ul");

          const items = Array.isArray(s.items) ? s.items : [];
          for (const it of items) {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = it.url || "#";
            a.textContent = it.label || it.url || "link";
            li.appendChild(a);
            ul.appendChild(li);
          }

          sec.appendChild(h3);
          sec.appendChild(ul);
          frag.appendChild(sec);
        }

        container.innerHTML = "";
        container.appendChild(frag);
      }

      /* ========= Search / Commands ========= */
      const searchForm = $("#search-form");
      const searchInput = $("#search_box");

      const GLOBAL_SHORTCUTS = {
        g:   (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
        ddg: (q) => `https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
        yt:  (q) => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
        r:   (q) => `https://www.reddit.com/search/?q=${encodeURIComponent(q)}`,
        hn:  (q) => `https://hn.algolia.com/?q=${encodeURIComponent(q)}`
      };
      const RE_URL = /^(((http|https):\/\/)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,})(\/\S*)?$/;
      const RE_IP  = /^(((http|https):\/\/)?((\d{1,3}\.){3}\d{1,3}|localhost))(:(\d{1,5}))?(\/\S*)?$/;

      function navigate(url) { window.location.href = url; }

      function runCommand(line) {
        const [cmd, ...rest] = line.slice(1).trim().split(/\s+/);
        const arg = rest.join(" ");

        switch (cmd) {
          case "help":
            alert([
              ">help",
              ">profile list",
              ">profile switch <id>",
              ">note <text>           — append to scratchpad",
              ">notes                 — view scratchpad",
              ">clear-notes           — clear scratchpad",
              ">tz add <IANA_tz>      — add timezone",
              ">tz remove <IANA_tz>   — remove timezone"
            ].join("\n"));
            break;

          case "profile": {
            const sub  = rest[0];
            const name = rest.slice(1).join(" ");
            if (sub === "list") {
              const lines = PROFILES.map(p => `${p.id} — ${p.label}${p.id===ACTIVE_PROFILE?" (current)":""}`);
              alert(`Profiles:\n${lines.join("\n")}`);
            } else if (sub === "switch") {
              const target = PROFILES.find(p => p.id === name);
              if (!target) return alert(`Unknown profile: ${name}`);
              setProfile(target.id);
            } else {
              alert("Usage:\n>profile list\n>profile switch <id>");
            }
            break;
          }

          case "note":
            if (!scratch) return;
            scratch.value += (scratch.value ? "\n" : "") + arg;
            localStorage.setItem("scratchpad", scratch.value);
            break;

          case "notes":
            alert((scratch && scratch.value) || "(empty)");
            break;

          case "clear-notes":
            if (!scratch) return;
            scratch.value = "";
            localStorage.removeItem("scratchpad");
            break;

          case "tz": {
            const sub = rest[0];
            const zone = rest.slice(1).join(" ");
            if (sub === "add" && zone) {
              if (!timezones.includes(zone)) timezones.push(zone);
              renderClocks();
            } else if (sub === "remove" && zone) {
              const i = timezones.indexOf(zone);
              if (i >= 0) timezones.splice(i, 1);
              renderClocks();
            } else {
              alert("Usage: >tz add <IANA_tz> | >tz remove <IANA_tz>");
            }
            break;
          }

          default:
            alert(`Unknown command: ${cmd}. Try >help`);
        }
      }

      function handleSearch(raw) {
        const text = raw.trim();
        if (!text) return;

        if (text.startsWith(">")) { runCommand(text); return; }

        const [key, ...rest] = text.split(/\s+/);
        const q = rest.join(" ");
        if (GLOBAL_SHORTCUTS[key]) { navigate(GLOBAL_SHORTCUTS[key](q)); return; }

        if (RE_URL.test(text)) { navigate(text.startsWith("http") ? text : "https://" + text); return; }
        if (RE_IP.test(text))  { navigate(text.startsWith("http") ? text : "http://"  + text); return; }

        navigate(`https://duckduckgo.com/?q=${encodeURIComponent(text)}`);
      }

      /* ========= Init ========= */
      document.addEventListener("DOMContentLoaded", async () => {
        // clocks
        renderClocks();
        if (clockTimer) clearInterval(clockTimer);
        clockTimer = setInterval(updateClocks, 1000);

        // autofocus + shortcuts
        const si = $("#search_box");
        si?.focus(); si?.select();
        document.getElementById("search-form")?.addEventListener("submit", (e) => {
          e.preventDefault();
          handleSearch(si.value);
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "/" && document.activeElement !== si) {
            e.preventDefault(); si?.focus(); si?.select();
          } else if (e.key === "Escape" && document.activeElement === si) {
            si.value = "";
          }
        });

        // profiles + links
        await loadProfiles();
        pickInitialProfile();
        renderProfileMenu();
        await loadLinksByProfile();
      });
    </script>
  </body>
</html>
